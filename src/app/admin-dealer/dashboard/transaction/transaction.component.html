<section class="content">
  <div class="d-flex justify-content-center align-items-center container">
    <div class="row">
      <div class="mt-5">
        <form [formGroup]="saleForm" (ngSubmit)="submitSale()">
          <!-- Customer Name -->
          <div class="">
            <div class="col-md-6">
              <mat-form-field class="w-100">
                <mat-label>Customer Name (Optional)</mat-label>
                <input matInput type="text" formControlName="customerName">
              </mat-form-field>

              <!-- Product ID with Search Icon -->
              <mat-form-field class="w-100">
                <mat-label>Product ID</mat-label>
                <input matInput type="text" placeholder="Click the search icon" readonly>
                <button mat-icon-button matSuffix (click)="fetchProducts()">
                  <mat-icon>search</mat-icon>
                </button>
              </mat-form-field>
            </div>
          </div>

          <!-- Product Search Table -->
          <div *ngIf="showProductTable" class="content mb-5 content-block">
            <div class="mat-elevation-z8">
              <div class="table-responsive">
                <table mat-table [dataSource]="items" class="mat-table">
                  <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef> ID </th>
                    <td mat-cell *matCellDef="let item"> {{ item.id }} </td>
                  </ng-container>

                  <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef> Name </th>
                    <td mat-cell *matCellDef="let item"> {{ item.name }} </td>
                  </ng-container>

                  <ng-container matColumnDef="branch">
                    <th mat-header-cell *matHeaderCellDef> Branch </th>
                    <td mat-cell *matCellDef="let item"> {{ item.branch?.name }} </td>
                  </ng-container>

                  <ng-container matColumnDef="price">
                    <th mat-header-cell *matHeaderCellDef> Price </th>
                    <td mat-cell *matCellDef="let item"> {{ item.price || 'N/A' }} </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="['id', 'name', 'branch', 'price']"></tr>
                  <tr mat-row *matRowDef="let row; columns: ['id', 'name', 'branch', 'price'];" 
                      (click)="selectProduct(row)">
                  </tr>
                </table>
              </div>
              <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons class="mt-3"></mat-paginator>
            </div>
          </div>
          <p *ngIf="items.length === 0">No products found.</p>

          <!-- Selected Products Table -->
          <div *ngIf="selectedProducts.length > 0" class="content mb-5 content-block">
            <div class="mat-elevation-z8">
              <div class="table-responsive">
                <table mat-table [dataSource]="selectedProducts" class="mat-table">
                  <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef>Product ID</th>
                    <td mat-cell *matCellDef="let product"> {{ product.id }} </td>
                  </ng-container>

                  <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef>Product Name</th>
                    <td mat-cell *matCellDef="let product"> {{ product.name }} </td>
                  </ng-container>

                  <ng-container matColumnDef="branch">
                    <th mat-header-cell *matHeaderCellDef>Branch</th>
                    <td mat-cell *matCellDef="let product"> {{ product.branch }} </td>
                  </ng-container>

                  <ng-container matColumnDef="price">
                    <th mat-header-cell *matHeaderCellDef>Price</th>
                    <td mat-cell *matCellDef="let product"> {{ product.price }} </td>
                  </ng-container>

                  <ng-container matColumnDef="quantity">
                    <th mat-header-cell *matHeaderCellDef>Quantity</th>
                    <td mat-cell *matCellDef="let product; let i = index">
                      <mat-form-field appearance="outline" class="w-100">
                        <input 
                          matInput 
                          type="number" 
                          formControlName="quantity"
                          (input)="updateSubtotal(product.id, $event.target.value)"
                        >
                      </mat-form-field>
                    </td>
                  </ng-container>
                  

                  <ng-container matColumnDef="subtotal">
                    <th mat-header-cell *matHeaderCellDef>Subtotal</th>
                    <td mat-cell *matCellDef="let product"> {{ product.subTotal }} </td>
                  </ng-container>

                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Action</th>
                    <td mat-cell *matCellDef="let product; let i = index">
                      <button mat-button color="warn" (click)="removeProduct(i)">Remove</button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="['id', 'name', 'branch', 'price', 'quantity', 'subtotal', 'actions']"></tr>
                  <tr mat-row *matRowDef="let row; columns: ['id', 'name', 'branch', 'price', 'quantity', 'subtotal', 'actions'];">
                  </tr>
                </table>
              </div>
              <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons class="mt-3"></mat-paginator>
            </div>
          </div>

          <!-- Submit Button Disabled If No Products Selected -->
          <div class="d-flex mt-3">
            <button mat-raised-button color="primary" type="submit" [disabled]="selectedProducts.length === 0">
              Submit Sale
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
